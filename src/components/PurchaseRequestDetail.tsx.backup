import React, { useState } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Typography,
  Box,
  Card,
  CardContent,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Chip,
  TextField,
  Alert,
  CircularProgress,
  IconButton,
  Divider,
  Collapse,
  CardHeader,
} from '@mui/material';
import {
  Close as CloseIcon,
  ExpandMore as ExpandMoreIcon,
  ExpandLess as ExpandLessIcon,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDateFns } from '@mui/x-date-pickers/AdapterDateFns';
import { doc, updateDoc, arrayUnion, Timestamp } from 'firebase/firestore';
import { db } from '../firebase';
import { useAuth } from '../contexts/AuthContext';
import { PurchaseRequest, BranchDispatchInfo } from '../types';

interface PurchaseRequestDetailProps {
  open: boolean;
  onClose: () => void;
  request: PurchaseRequest | null;
  onUpdate: () => void;
  editMode?: boolean;  // í¸ì§‘ ëª¨ë“œ ì—¬ë¶€
  editSection?: string; // í¸ì§‘í•  ì„¹ì…˜ ('ecount' | 'po' | 'warehouse' | 'dispatch' | 'receipt')
}

const PurchaseRequestDetail: React.FC<PurchaseRequestDetailProps> = ({
  open,
  onClose,
  request,
  onUpdate,
  editMode,
  editSection,
}) => {
  const { userProfile } = useAuth();
  const [processing, setProcessing] = useState(false);
  const [error, setError] = useState('');
  const [comment, setComment] = useState('');

  // Phase 2: êµ¬ë§¤ì²˜ ë°œì£¼ ê´€ë ¨ ìƒíƒœ
  const [expectedDeliveryDate, setExpectedDeliveryDate] = useState<Date | null>(null);
  const [expectedDeliveryQuantity, setExpectedDeliveryQuantity] = useState<number>(0);
  const [actualSupplier, setActualSupplier] = useState('');
  const [poMemo, setPoMemo] = useState('');

  // Phase 2: ë¬¼ë¥˜ì°½ê³  ì…ê³  ê´€ë ¨ ìƒíƒœ
  const [actualReceiptDate, setActualReceiptDate] = useState<Date | null>(new Date());
  const [actualReceivedQuantity, setActualReceivedQuantity] = useState<number>(0);
  const [warehouseReceiptMemo, setWarehouseReceiptMemo] = useState('');

  // Phase 2: ì§€ì  ì¶œê³  ê´€ë ¨ ìƒíƒœ
  const [branchDispatchQuantities, setBranchDispatchQuantities] = useState<BranchDispatchInfo[]>([]);
  const [dispatchMemo, setDispatchMemo] = useState('');

  // Phase 2: ì§€ì  ì…ê³  í™•ì¸ ê´€ë ¨ ìƒíƒœ
  const [branchReceiptQuantities, setBranchReceiptQuantities] = useState<BranchDispatchInfo[]>([]);

  // ì§€ì ë³„ ì¶œê³  ìˆ˜ëŸ‰ í¸ì§‘ ëª¨ë“œ ìƒíƒœ
  const [editingBranchIndex, setEditingBranchIndex] = useState<number | null>(null);

  // ì´ì¹´ìš´íŠ¸ ë“±ë¡ìš© í’ˆëª©ê·¸ë£¹ ìƒíƒœ
  const [itemGroup1, setItemGroup1] = useState('');
  const [itemGroup2, setItemGroup2] = useState('');
  const [itemGroup3, setItemGroup3] = useState('');

  // í¼ì¹˜ê¸°/ì ‘ê¸° ìƒíƒœ ê´€ë¦¬
  const [expandedSections, setExpandedSections] = useState({
    basicInfo: true,       // ê¸°ë³¸ ì •ë³´ (í•­ìƒ ì—´ë¦¼)
    partInfo: false,       // ë¶€í’ˆ ì •ë³´ (ê¸°ë³¸ ì ‘í˜ìœ¼ë¡œ ë³€ê²½)  
    progressInfo: false,   // ì§„í–‰ ìƒì„¸ ì •ë³´
    branchInfo: false,     // ì§€ì ë³„ ìš”ì²­ìˆ˜ëŸ‰
    history: false,       // ìƒíƒœ íˆìŠ¤í† ë¦¬
  });

  // í¼ì¹˜ê¸°/ì ‘ê¸° í† ê¸€ í•¨ìˆ˜
  const toggleSection = (section: keyof typeof expandedSections) => {
    setExpandedSections(prev => ({
      ...prev,
      [section]: !prev[section]
    }));
  };

  // ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
  React.useEffect(() => {
    if (request) {
      // í¸ì§‘ ëª¨ë“œì¼ ë•Œ ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
      if (editMode && editSection) {
        switch (editSection) {
          case 'ecount':
            if (request.itemGroup1) {
              setItemGroup1(request.itemGroup1);
            }
            if (request.itemGroup2) {
              setItemGroup2(request.itemGroup2);
            }
            if (request.itemGroup3) {
              setItemGroup3(request.itemGroup3);
            }
            break;
          case 'po':
            if (request.expectedDeliveryDate) {
              setExpectedDeliveryDate(request.expectedDeliveryDate);
            }
            if (request.expectedDeliveryQuantity) {
              setExpectedDeliveryQuantity(request.expectedDeliveryQuantity);
            }
            if (request.actualSupplier) {
              setActualSupplier(request.actualSupplier);
            }
            if (request.poMemo) {
              setPoMemo(request.poMemo);
            }
            break;
          case 'warehouse':
            if (request.warehouseReceiptAt) {
              setActualReceiptDate(request.warehouseReceiptAt);
            }
            if (request.actualReceivedQuantity) {
              setActualReceivedQuantity(request.actualReceivedQuantity);
            }
            if (request.warehouseReceiptMemo) {
              setWarehouseReceiptMemo(request.warehouseReceiptMemo);
            }
            break;
          case 'dispatch':
            if (request.dispatchMemo) {
              setDispatchMemo(request.dispatchMemo);
            }
            // branchDispatchQuantitiesëŠ” í•˜ë‹¨ì˜ í†µí•© ì´ˆê¸°í™” ë¡œì§ì—ì„œ ì²˜ë¦¬
            break;
          case 'receipt':
            if (request.branchDispatchQuantities) {
              setBranchReceiptQuantities(request.branchDispatchQuantities);
            }
            break;
        }
      } else {
        // ì¼ë°˜ ëª¨ë“œì¼ ë•Œ ê¸°ë³¸ê°’ ì„¤ì •
        setExpectedDeliveryQuantity(request.totalRequestedQuantity);
        setActualReceivedQuantity(request.expectedDeliveryQuantity || request.totalRequestedQuantity);
        
        // ì´ì¹´ìš´íŠ¸ ë“±ë¡ ëª¨ë“œì—ì„œ ê¸°ì¡´ í’ˆëª©ê·¸ë£¹ ì •ë³´ ë¡œë“œ (í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œë„)
        if (!editMode && request.currentStatus === 'operations_submitted') {
          if (request.itemGroup1) {
            setItemGroup1(request.itemGroup1);
          }
          if (request.itemGroup2) {
            setItemGroup2(request.itemGroup2);
          }
          if (request.itemGroup3) {
            setItemGroup3(request.itemGroup3);
          }
        }
      }
      
      // ì§€ì ë³„ ì¶œê³  ìˆ˜ëŸ‰ ì´ˆê¸°í™”
      if (editMode && editSection === 'dispatch') {
        // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ branchDispatchQuantitiesê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ branchRequirementsë¡œ ì´ˆê¸°í™”
        console.log('í¸ì§‘ ëª¨ë“œ - dispatch ì„¹ì…˜ ì´ˆê¸°í™”:', {
          branchDispatchQuantities: request.branchDispatchQuantities,
          branchRequirements: request.branchRequirements,
          currentStatus: request.currentStatus
        });
        
        if (request.branchDispatchQuantities && request.branchDispatchQuantities.length > 0) {
          setBranchDispatchQuantities(request.branchDispatchQuantities);
        } else if (request.branchRequirements && request.branchRequirements.length > 0) {
          const initialDispatchQuantities = request.branchRequirements.map(req => ({
            branchId: req.branchId,
            branchName: req.branchName,
            requiredQuantity: Number(req.requestedQuantity),
            dispatchedQuantity: Number(req.requestedQuantity),
            confirmedQuantity: undefined,
            branchReceiptMemo: '',
          }));
          console.log('í¸ì§‘ ëª¨ë“œ - ì´ˆê¸°í™”ëœ ì§€ì ë³„ ìˆ˜ëŸ‰:', initialDispatchQuantities);
          setBranchDispatchQuantities(initialDispatchQuantities);
        } else {
          // branchRequirementsê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ì§€ì  ìƒì„±
          console.warn('âš ï¸ branchRequirementsê°€ ì—†ì–´ ê¸°ë³¸ ì§€ì ì„ ìƒì„±í•©ë‹ˆë‹¤.');
          const fallbackDispatchQuantities = [
            {
              branchId: 'fallback-1',
              branchName: 'ê¸°ë³¸ ì§€ì ',
              requiredQuantity: request.totalRequestedQuantity - (request.logisticsStockQuantity || 0),
              dispatchedQuantity: request.totalRequestedQuantity - (request.logisticsStockQuantity || 0),
              confirmedQuantity: undefined,
              branchReceiptMemo: '',
            }
          ];
          setBranchDispatchQuantities(fallbackDispatchQuantities);
        }
      } else if (!editMode && (request.currentStatus === 'warehouse_received' || request.currentStatus === 'partial_dispatched')) {
        // ì¼ë°˜ ëª¨ë“œì—ì„œ ì§€ì  ì¶œê³  ì²˜ë¦¬í•  ë•Œ (warehouse_received ë˜ëŠ” partial_dispatched ìƒíƒœ)
        console.log('ì¼ë°˜ ëª¨ë“œ - ì§€ì  ì¶œê³  ìƒíƒœ ì´ˆê¸°í™”:', {
          currentStatus: request.currentStatus,
          branchDispatchQuantities: request.branchDispatchQuantities,
          branchRequirements: request.branchRequirements
        });
        
        // partial_dispatched ìƒíƒœì—ì„œëŠ” ê¸°ì¡´ dispatchMemoë„ ë³µì›
        if (request.currentStatus === 'partial_dispatched' && request.dispatchMemo) {
          setDispatchMemo(request.dispatchMemo);
        }
        
        if (request.branchDispatchQuantities && request.branchDispatchQuantities.length > 0) {
          // partial_dispatched ìƒíƒœì—ì„œëŠ” ê¸°ì¡´ branchDispatchQuantities ì‚¬ìš©
          console.log('ê¸°ì¡´ ë¶€ë¶„ì¶œê³  ë°ì´í„° ë³µì›:', request.branchDispatchQuantities);
          setBranchDispatchQuantities(request.branchDispatchQuantities);
        } else if (request.branchRequirements && request.branchRequirements.length > 0) {
          // warehouse_received ìƒíƒœì—ì„œëŠ” branchRequirementsë¡œ ì´ˆê¸°í™”
          const initialDispatchQuantities = request.branchRequirements.map(req => ({
            branchId: req.branchId,
            branchName: req.branchName,
            requiredQuantity: Number(req.requestedQuantity),
            dispatchedQuantity: Number(req.requestedQuantity),
            confirmedQuantity: undefined,
            branchReceiptMemo: '',
          }));
          console.log('ì¼ë°˜ ëª¨ë“œ - ì´ˆê¸°í™”ëœ ì§€ì ë³„ ìˆ˜ëŸ‰:', initialDispatchQuantities);
          setBranchDispatchQuantities(initialDispatchQuantities);
        } else {
          // branchRequirementsê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ì§€ì  ìƒì„±
          console.warn('âš ï¸ branchRequirementsê°€ ì—†ì–´ ê¸°ë³¸ ì§€ì ì„ ìƒì„±í•©ë‹ˆë‹¤.');
          const fallbackDispatchQuantities = [
            {
              branchId: 'fallback-1',
              branchName: 'ê¸°ë³¸ ì§€ì ',
              requiredQuantity: request.totalRequestedQuantity - (request.logisticsStockQuantity || 0),
              dispatchedQuantity: request.totalRequestedQuantity - (request.logisticsStockQuantity || 0),
              confirmedQuantity: undefined,
              branchReceiptMemo: '',
            }
          ];
          setBranchDispatchQuantities(fallbackDispatchQuantities);
        }
      }

      // ì§€ì ë³„ ìˆ˜ë ¹ í™•ì¸ ì´ˆê¸°í™”
      if (request.currentStatus === 'branch_dispatched' && request.branchDispatchQuantities) {
        setBranchReceiptQuantities(request.branchDispatchQuantities.map(item => ({
          ...item,
          confirmedQuantity: item.dispatchedQuantity, // ê¸°ë³¸ê°’ì€ ì¶œê³  ìˆ˜ëŸ‰ê³¼ ë™ì¼
        })));
      }
    }
  }, [request, editMode, editSection]);

  // Phase 2: ìƒíƒœë³„ ì²˜ë¦¬ í•¨ìˆ˜ë“¤
  const handleEcountRegistration = async () => {
    if (!request) {
      setError('ìš”ì²­ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // í’ˆëª©ê·¸ë£¹ í•„ìˆ˜ ê²€ì¦
    if (!itemGroup1.trim() || !itemGroup2.trim() || !itemGroup3.trim()) {
      setError('í’ˆëª©ê·¸ë£¹ 1, 2, 3ì€ ëª¨ë‘ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
      return;
    }

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      const newHistoryEntry = {
        status: 'ecount_registered',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: comment.trim() || 'ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì™„ë£Œ',
      };

      await updateDoc(requestRef, {
        currentStatus: 'ecount_registered',
        currentResponsibleTeam: 'logistics',
        ecountRegisteredAt: Timestamp.now(),
        ecountRegistrarUid: userProfile?.id || '',
        itemGroup1: itemGroup1.trim(),
        itemGroup2: itemGroup2.trim(),
        itemGroup3: itemGroup3.trim(),
        statusHistory: arrayUnion(newHistoryEntry),
        updatedAt: Timestamp.now(),
      });

      setComment('');
      setItemGroup1('');
      setItemGroup2('');
      setItemGroup3('');
      onUpdate();
      onClose();
      
    } catch (error) {
      console.error('ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
      setError('ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  // í¸ì§‘ ëª¨ë“œìš©: ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì •ë³´ ìˆ˜ì •
  const handleEcountUpdate = async () => {
    if (!request) {
      setError('ìš”ì²­ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // í’ˆëª©ê·¸ë£¹ í•„ìˆ˜ ê²€ì¦
    if (!itemGroup1.trim() || !itemGroup2.trim() || !itemGroup3.trim()) {
      setError('í’ˆëª©ê·¸ë£¹ 1, 2, 3ì€ ëª¨ë‘ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
      return;
    }

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      const updateHistoryEntry = {
        status: 'ecount_updated',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: comment.trim() ? `ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì •ë³´ ìˆ˜ì •: ${comment}` : 'ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì •ë³´ ìˆ˜ì •',
      };

      await updateDoc(requestRef, {
        ecountRegistrarUid: userProfile?.id || '',
        itemGroup1: itemGroup1.trim(),
        itemGroup2: itemGroup2.trim(),
        itemGroup3: itemGroup3.trim(),
        statusHistory: arrayUnion(updateHistoryEntry),
        updatedAt: Timestamp.now(),
      });

      setComment('');
      setItemGroup1('');
      setItemGroup2('');
      setItemGroup3('');
      onUpdate();
      onClose();
      
    } catch (error) {
      console.error('ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨:', error);
      setError('ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  const handlePOCompletion = async () => {
    if (!request || !expectedDeliveryDate || expectedDeliveryQuantity <= 0 || !comment.trim()) {
      setError('ì…ê³  ì˜ˆì •ì¼, ì…ê³  ì˜ˆì • ìˆ˜ëŸ‰, ì½”ë©˜íŠ¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      const newHistoryEntry = {
        status: 'po_completed',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: comment,
      };

      await updateDoc(requestRef, {
        currentStatus: 'po_completed',
        currentResponsibleTeam: 'logistics',
        poCompletedAt: Timestamp.now(),
        poCompleterUid: userProfile?.id || '',
        expectedDeliveryDate: Timestamp.fromDate(expectedDeliveryDate),
        expectedDeliveryQuantity: expectedDeliveryQuantity,
        actualSupplier: actualSupplier || request.initialSupplier,
        poMemo: poMemo,
        statusHistory: arrayUnion(newHistoryEntry),
        updatedAt: Timestamp.now(),
      });

      setComment('');
      setActualSupplier('');
      setPoMemo('');
      onUpdate();
      onClose();
      
    } catch (error) {
      console.error('ë°œì£¼ ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
      setError('ë°œì£¼ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  const handleWarehouseReceipt = async () => {
    if (!request || !actualReceiptDate || actualReceivedQuantity <= 0 || !comment.trim()) {
      setError('ì‹¤ì œ ì…ê³ ì¼, ì‹¤ì œ ì…ê³  ìˆ˜ëŸ‰, ì½”ë©˜íŠ¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      const newHistoryEntry = {
        status: 'warehouse_received',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: comment,
      };

      await updateDoc(requestRef, {
        currentStatus: 'warehouse_received',
        currentResponsibleTeam: 'logistics',
        warehouseReceiptAt: Timestamp.fromDate(actualReceiptDate),
        warehouseReceiptUid: userProfile?.id || '',
        actualReceivedQuantity: actualReceivedQuantity,
        warehouseReceiptMemo: warehouseReceiptMemo,
        statusHistory: arrayUnion(newHistoryEntry),
        updatedAt: Timestamp.now(),
      });

      setComment('');
      setWarehouseReceiptMemo('');
      onUpdate();
      onClose();
      
    } catch (error) {
      console.error('ì…ê³  ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
      setError('ì…ê³  ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  const handleBranchDispatch = async () => {
    if (!request) {
      setError('ìš”ì²­ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ì´ ì¶œê³  ìˆ˜ëŸ‰ ê²€ì¦
    const totalDispatchedQuantity = branchDispatchQuantities.reduce((sum, item) => sum + item.dispatchedQuantity, 0);
    const availableQuantity = request.actualReceivedQuantity || 0;

    if (totalDispatchedQuantity > availableQuantity) {
      setError(`ì°½ê³  ë³´ìœ  ìˆ˜ëŸ‰(${availableQuantity}ê°œ)ì„ ì´ˆê³¼í•˜ì—¬ ì¶œê³ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í˜„ì¬ ì¶œê³  ê³„íš: ${totalDispatchedQuantity}ê°œ)`);
      return;
    }

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      const newHistoryEntry = {
        status: 'branch_dispatched',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: comment.trim() || 'ì§€ì  ì¶œê³  ì™„ë£Œ',
      };

      const updateData = removeUndefinedValues({
        currentStatus: 'branch_dispatched',
        currentResponsibleTeam: 'operations',
        branchDispatchCompletedAt: Timestamp.now(),
        branchDispatchCompleterUid: userProfile?.id || '',
        branchDispatchQuantities: branchDispatchQuantities.map(branch => removeUndefinedValues(branch)),
        dispatchMemo: dispatchMemo,
        statusHistory: arrayUnion(newHistoryEntry),
        updatedAt: Timestamp.now(),
      });

      await updateDoc(requestRef, updateData);

      setComment('');
      setDispatchMemo('');
      onUpdate();
      onClose();
      
    } catch (error) {
      console.error('ì§€ì  ì¶œê³  ì²˜ë¦¬ ì‹¤íŒ¨:', error);
      setError('ì§€ì  ì¶œê³  ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  const handleBranchReceiptConfirmation = async () => {
    if (!request || !comment.trim()) {
      setError('ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      const newHistoryEntry = {
        status: 'branch_received_confirmed',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: comment,
      };

      await updateDoc(requestRef, {
        currentStatus: 'branch_received_confirmed',
        currentResponsibleTeam: 'completed',
        branchReceiptConfirmedAt: Timestamp.now(),
        branchReceiptConfirmerUid: userProfile?.id || '',
        branchDispatchQuantities: branchReceiptQuantities,
        statusHistory: arrayUnion(newHistoryEntry),
        updatedAt: Timestamp.now(),
      });

      setComment('');
      onUpdate();
      onClose();
      
    } catch (error) {
      console.error('ì§€ì  ì…ê³  í™•ì¸ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
      setError('ì§€ì  ì…ê³  í™•ì¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  // ì§€ì ë³„ ì¶œê³  ìˆ˜ëŸ‰ ë³€ê²½ í•¸ë“¤ëŸ¬
  const handleBranchDispatchQuantityChange = (index: number, quantity: number) => {
    const updated = [...branchDispatchQuantities];
    updated[index] = { ...updated[index], dispatchedQuantity: quantity };
    setBranchDispatchQuantities(updated);
  };

  // ì§€ì ë³„ ìˆ˜ë ¹ ìˆ˜ëŸ‰ ë³€ê²½ í•¸ë“¤ëŸ¬
  const handleBranchReceiptQuantityChange = (index: number, quantity: number) => {
    const updated = [...branchReceiptQuantities];
    updated[index] = { ...updated[index], confirmedQuantity: quantity };
    setBranchReceiptQuantities(updated);
  };

  // ì§€ì ë³„ ìˆ˜ë ¹ ë©”ëª¨ ë³€ê²½ í•¸ë“¤ëŸ¬
  const handleBranchReceiptMemoChange = (index: number, memo: string) => {
    const updated = [...branchReceiptQuantities];
    updated[index] = { ...updated[index], branchReceiptMemo: memo };
    setBranchReceiptQuantities(updated);
  };

  // ìƒíƒœ ë¼ë²¨ ë§¤í•‘ (Phase 2 í™•ì¥)
  const getStatusLabel = (status: string) => {
    switch (status) {
      case 'operations_submitted': return 'ìš´ì˜ë¶€ ìš”ì²­ ì™„ë£Œ';
      case 'ecount_registered': return 'ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì™„ë£Œ';
      case 'po_completed': return 'êµ¬ë§¤ì²˜ ë°œì£¼ ì™„ë£Œ';
      case 'warehouse_received': return 'ë¬¼ë¥˜ì°½ê³  ì…ê³  ì™„ë£Œ';
      case 'partial_dispatched': return 'ë¶€ë¶„ ì¶œê³  ì™„ë£Œ';
      case 'branch_dispatched': return 'ì „ì²´ ì§€ì  ì¶œê³  ì™„ë£Œ';
      case 'branch_received_confirmed': return 'ì§€ì  ì…ê³  í™•ì¸ (ì™„ë£Œ)';
      default: return status;
    }
  };

  // ìƒíƒœ ìƒ‰ìƒ ë§¤í•‘ (Phase 2 í™•ì¥)
  const getStatusColor = (status: string) => {
    switch (status) {
      case 'operations_submitted': return 'info';
      case 'ecount_registered': return 'primary';
      case 'po_completed': return 'warning';
      case 'warehouse_received': return 'secondary';
      case 'partial_dispatched': return 'warning';
      case 'branch_dispatched': return 'default';
      case 'branch_received_confirmed': return 'success';
      default: return 'default';
    }
  };

  // ì¤‘ìš”ë„ ë¼ë²¨ ë§¤í•‘
  const getImportanceLabel = (importance: string) => {
    switch (importance) {
      case 'low': return 'ë‚®ìŒ';
      case 'medium': return 'ë³´í†µ';
      case 'high': return 'ë†’ìŒ';
      case 'urgent': return 'ê¸´ê¸‰';
      default: return importance;
    }
  };

  // ì¤‘ìš”ë„ ìƒ‰ìƒ ë§¤í•‘
  const getImportanceColor = (importance: string) => {
    switch (importance) {
      case 'low': return 'default';
      case 'medium': return 'info';
      case 'high': return 'warning';
      case 'urgent': return 'error';
      default: return 'default';
    }
  };

  // í¸ì§‘ ëª¨ë“œìš©: êµ¬ë§¤ì²˜ ë°œì£¼ ì •ë³´ ìˆ˜ì •
  const handlePOUpdate = async () => {
    if (!request || !expectedDeliveryDate || expectedDeliveryQuantity <= 0 || !comment.trim()) {
      setError('ì…ê³  ì˜ˆì •ì¼, ì…ê³  ì˜ˆì • ìˆ˜ëŸ‰, ìˆ˜ì • ì‚¬ìœ ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      const updateHistoryEntry = {
        status: 'po_updated',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: `êµ¬ë§¤ì²˜ ë°œì£¼ ì •ë³´ ìˆ˜ì •: ${comment}`,
      };

      await updateDoc(requestRef, {
        expectedDeliveryDate: Timestamp.fromDate(expectedDeliveryDate),
        expectedDeliveryQuantity: expectedDeliveryQuantity,
        actualSupplier: actualSupplier || request.initialSupplier,
        poMemo: poMemo,
        poCompleterUid: userProfile?.id || '',
        statusHistory: arrayUnion(updateHistoryEntry),
        updatedAt: Timestamp.now(),
      });

      setComment('');
      setActualSupplier('');
      setPoMemo('');
      onUpdate();
      onClose();
      
    } catch (error) {
      console.error('êµ¬ë§¤ì²˜ ë°œì£¼ ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨:', error);
      setError('êµ¬ë§¤ì²˜ ë°œì£¼ ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  // í¸ì§‘ ëª¨ë“œìš©: ë¬¼ë¥˜ì°½ê³  ì…ê³  ì •ë³´ ìˆ˜ì •
  const handleWarehouseUpdate = async () => {
    if (!request || !actualReceiptDate || actualReceivedQuantity <= 0 || !comment.trim()) {
      setError('ì‹¤ì œ ì…ê³ ì¼, ì‹¤ì œ ì…ê³  ìˆ˜ëŸ‰, ìˆ˜ì • ì‚¬ìœ ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      const updateHistoryEntry = {
        status: 'warehouse_updated',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: `ë¬¼ë¥˜ì°½ê³  ì…ê³  ì •ë³´ ìˆ˜ì •: ${comment}`,
      };

      await updateDoc(requestRef, {
        warehouseReceiptAt: Timestamp.fromDate(actualReceiptDate),
        actualReceivedQuantity: actualReceivedQuantity,
        warehouseReceiptMemo: warehouseReceiptMemo,
        warehouseReceiptUid: userProfile?.id || '',
        statusHistory: arrayUnion(updateHistoryEntry),
        updatedAt: Timestamp.now(),
      });

      setComment('');
      setWarehouseReceiptMemo('');
      onUpdate();
      onClose();
      
    } catch (error) {
      console.error('ë¬¼ë¥˜ì°½ê³  ì…ê³  ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨:', error);
      setError('ë¬¼ë¥˜ì°½ê³  ì…ê³  ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  // í¸ì§‘ ëª¨ë“œìš©: ì§€ì  ì¶œê³  ì •ë³´ ìˆ˜ì •
  const handleDispatchUpdate = async () => {
    if (!request) {
      setError('ìš”ì²­ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ì´ ì¶œê³  ìˆ˜ëŸ‰ ê²€ì¦
    const totalDispatchedQuantity = branchDispatchQuantities.reduce((sum, item) => sum + item.dispatchedQuantity, 0);
    const availableQuantity = request.actualReceivedQuantity || 0;

    if (totalDispatchedQuantity > availableQuantity) {
      setError(`ì°½ê³  ë³´ìœ  ìˆ˜ëŸ‰(${availableQuantity}ê°œ)ì„ ì´ˆê³¼í•˜ì—¬ ì¶œê³ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í˜„ì¬ ì¶œê³  ê³„íš: ${totalDispatchedQuantity}ê°œ)`);
      return;
    }

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      const updateHistoryEntry = {
        status: 'dispatch_updated',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: comment.trim() ? `ì§€ì  ì¶œê³  ì •ë³´ ìˆ˜ì •: ${comment}` : 'ì§€ì  ì¶œê³  ì •ë³´ ìˆ˜ì •',
      };

      const updateData = removeUndefinedValues({
        branchDispatchQuantities: branchDispatchQuantities.map(branch => removeUndefinedValues(branch)),
        dispatchMemo: dispatchMemo,
        branchDispatchCompleterUid: userProfile?.id || '',
        statusHistory: arrayUnion(updateHistoryEntry),
        updatedAt: Timestamp.now(),
      });

      await updateDoc(requestRef, updateData);

      setComment('');
      setDispatchMemo('');
      onUpdate();
      onClose();
      
    } catch (error) {
      console.error('ì§€ì  ì¶œê³  ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨:', error);
      setError('ì§€ì  ì¶œê³  ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  // í¸ì§‘ ëª¨ë“œìš©: ì§€ì  ì…ê³  í™•ì¸ ì •ë³´ ìˆ˜ì •
  const handleReceiptUpdate = async () => {
    if (!request || !comment.trim()) {
      setError('ìˆ˜ì • ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      const updateHistoryEntry = {
        status: 'receipt_updated',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: `ì§€ì  ì…ê³  í™•ì¸ ì •ë³´ ìˆ˜ì •: ${comment}`,
      };

      await updateDoc(requestRef, {
        branchDispatchQuantities: branchReceiptQuantities,
        branchReceiptConfirmerUid: userProfile?.id || '',
        statusHistory: arrayUnion(updateHistoryEntry),
        updatedAt: Timestamp.now(),
      });

      setComment('');
      onUpdate();
      onClose();
      
    } catch (error) {
      console.error('ì§€ì  ì…ê³  í™•ì¸ ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨:', error);
      setError('ì§€ì  ì…ê³  í™•ì¸ ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  // ì§€ì ë³„ ê°œë³„ ì¶œê³  ì™„ë£Œ ì²˜ë¦¬ (ë¡œì»¬ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸, DB ì €ì¥í•˜ì§€ ì•ŠìŒ)
  const handleIndividualBranchDispatch = async (branchIndex: number) => {
    if (!request) {
      setError('ìš”ì²­ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ë¡œì»¬ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸ (DB ì €ì¥ì€ í•˜ì§€ ì•ŠìŒ)
    const updatedBranchDispatchQuantities = [...branchDispatchQuantities];
    const targetBranch = updatedBranchDispatchQuantities[branchIndex];
    
    updatedBranchDispatchQuantities[branchIndex] = {
      ...targetBranch,
      actualDispatchedQuantity: targetBranch.dispatchedQuantity,
      isDispatched: true,
      dispatchedAt: new Date(),
      dispatchedByUid: userProfile?.id || '',
    };

    setBranchDispatchQuantities(updatedBranchDispatchQuantities);
    
    // âœ… ì°½ì„ ë‹«ì§€ ì•Šê³  ë¡œì»¬ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸
    // ì‚¬ìš©ìê°€ í•˜ë‹¨ ë²„íŠ¼ìœ¼ë¡œ ëª…ì‹œì  ì €ì¥ í•„ìš”
  };

  // ì§€ì ë³„ ì¶œê³  ì™„ë£Œ ì·¨ì†Œ (ë¡œì»¬ ìƒíƒœë§Œ ë³€ê²½)
  const handleUndoBranchDispatch = (branchIndex: number) => {
    const updatedBranchDispatchQuantities = [...branchDispatchQuantities];
    const targetBranch = updatedBranchDispatchQuantities[branchIndex];
    
    updatedBranchDispatchQuantities[branchIndex] = {
      ...targetBranch,
      actualDispatchedQuantity: undefined,
      isDispatched: false,
      dispatchedAt: undefined,
      dispatchedByUid: undefined,
    };

    setBranchDispatchQuantities(updatedBranchDispatchQuantities);
  };

  // ì§€ì ë³„ ì¶œê³  ìˆ˜ëŸ‰ í¸ì§‘ ëª¨ë“œ í† ê¸€
  const handleToggleEditBranch = (branchIndex: number) => {
    setEditingBranchIndex(editingBranchIndex === branchIndex ? null : branchIndex);
  };

  // í¸ì§‘ ëª¨ë“œì—ì„œ ìˆ˜ëŸ‰ ë³€ê²½ í™•ì •
  const handleConfirmEditBranch = (branchIndex: number) => {
    setEditingBranchIndex(null);
    
    // í¸ì§‘ëœ ìˆ˜ëŸ‰ìœ¼ë¡œ ë‹¤ì‹œ ì¶œê³  ì™„ë£Œ ì²˜ë¦¬
    const updatedBranchDispatchQuantities = [...branchDispatchQuantities];
    const targetBranch = updatedBranchDispatchQuantities[branchIndex];
    
    updatedBranchDispatchQuantities[branchIndex] = {
      ...targetBranch,
      actualDispatchedQuantity: targetBranch.dispatchedQuantity,
      isDispatched: true,
      dispatchedAt: new Date(),
      dispatchedByUid: userProfile?.id || '',
    };

    setBranchDispatchQuantities(updatedBranchDispatchQuantities);
  };

  // í˜„ì¬ ë¡œì»¬ ìƒíƒœë¥¼ DBì— ì €ì¥ (ì°½ ë‹«ì§€ ì•ŠìŒ)
  const handleSaveCurrentState = async () => {
    if (!request) {
      setError('ìš”ì²­ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      // í˜„ì¬ ì¶œê³  ìƒí™© ë¶„ì„
      const dispatchedBranches = branchDispatchQuantities.filter(branch => branch.isDispatched);
      const allDispatched = dispatchedBranches.length === branchDispatchQuantities.length && branchDispatchQuantities.length > 0;
      const totalDispatchedQuantity = dispatchedBranches.reduce((sum, branch) => sum + branch.dispatchedQuantity, 0);
      
      const newHistoryEntry = {
        status: allDispatched ? 'branch_dispatched' : 'partial_dispatched',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: comment.trim() || `${allDispatched ? 'ì „ì²´' : 'ë¶€ë¶„'} ì¶œê³  ì €ì¥ - ${dispatchedBranches.length}ê°œ ì§€ì  (ì´ ${totalDispatchedQuantity}ê°œ)`,
      };

      const updateData: any = {
        branchDispatchQuantities: branchDispatchQuantities,
        dispatchMemo: dispatchMemo,
        statusHistory: arrayUnion(newHistoryEntry),
        updatedAt: Timestamp.now(),
      };

      // ìƒíƒœ ì—…ë°ì´íŠ¸
      if (allDispatched) {
        updateData.currentStatus = 'branch_dispatched';
        updateData.currentResponsibleTeam = 'operations';
        updateData.branchDispatchCompletedAt = Timestamp.now();
        updateData.branchDispatchCompleterUid = userProfile?.id || '';
      } else if (request.currentStatus === 'warehouse_received') {
        updateData.currentStatus = 'partial_dispatched';
        updateData.currentResponsibleTeam = 'logistics';
      }

      await updateDoc(requestRef, updateData);

      setComment('');
      onUpdate();
      
      // âœ… ì°½ì„ ë‹«ì§€ ì•Šê³  ì €ì¥ë§Œ ì™„ë£Œ
      
    } catch (error) {
      console.error('í˜„ì¬ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', error);
      setError('í˜„ì¬ ìƒíƒœ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  // Firestoreì— ì €ì¥í•  ë•Œ undefined ê°’ ì œê±°í•˜ëŠ” ë„ìš°ë¯¸ í•¨ìˆ˜
  const removeUndefinedValues = (obj: any): any => {
    const cleaned: any = {};
    Object.keys(obj).forEach(key => {
      if (obj[key] !== undefined) {
        if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key]) && !(obj[key] instanceof Date)) {
          const nestedCleaned = removeUndefinedValues(obj[key]);
          if (Object.keys(nestedCleaned).length > 0) {
            cleaned[key] = nestedCleaned;
          }
        } else if (Array.isArray(obj[key])) {
          cleaned[key] = obj[key].map((item: any) => 
            typeof item === 'object' && item !== null ? removeUndefinedValues(item) : item
          );
        } else {
          cleaned[key] = obj[key];
        }
      }
    });
    return cleaned;
  };

  // ë¶€ë¶„ ì¶œê³  ìƒíƒœ ì €ì¥ (ì¼ë¶€ ì§€ì ë§Œ ì¶œê³ ëœ ê²½ìš°)
  const handlePartialDispatchSave = async () => {
    console.log('ğŸš€ ë¶€ë¶„ ì¶œê³  ì €ì¥ ì‹œì‘');
    
    if (!request) {
      console.error('âŒ requestê°€ ì—†ìŠµë‹ˆë‹¤.');
      setError('ìš”ì²­ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    console.log('ğŸ“Š í˜„ì¬ ìƒíƒœ:', {
      request: request.id,
      branchDispatchQuantities,
      comment: comment.trim(),
      dispatchMemo
    });

    try {
      setProcessing(true);
      setError('');

      const requestRef = doc(db, 'purchaseRequests', request.id);
      
      // í˜„ì¬ ì¶œê³ ëœ ì§€ì ë“¤ì˜ ì •ë³´ ì—…ë°ì´íŠ¸ (undefined ì œê±°)
      const cleanedBranchDispatchQuantities = branchDispatchQuantities.map(branch => 
        removeUndefinedValues({
          ...branch,
          actualDispatchedQuantity: branch.isDispatched ? branch.dispatchedQuantity : 0,
          dispatchedAt: branch.isDispatched ? (branch.dispatchedAt || new Date()) : undefined,
          dispatchedByUid: branch.isDispatched ? (branch.dispatchedByUid || userProfile?.id || '') : undefined,
        })
      );

      const dispatchedCount = cleanedBranchDispatchQuantities.filter(branch => branch.isDispatched).length;
      const totalDispatchedQuantity = cleanedBranchDispatchQuantities
        .filter(branch => branch.isDispatched)
        .reduce((sum, branch) => sum + branch.dispatchedQuantity, 0);
      
      console.log('ğŸ’¾ ì €ì¥í•  ë°ì´í„°:', {
        dispatchedCount,
        totalDispatchedQuantity,
        cleanedBranchDispatchQuantities
      });
      
      const newHistoryEntry = {
        status: 'partial_dispatched',
        updatedAt: Timestamp.now(),
        updatedByUid: userProfile?.id || '',
        updatedByName: userProfile?.name || '',
        comments: comment.trim() || `ì¼ë¶€ ì¶œê³  ì™„ë£Œ (${dispatchedCount}ê°œ ì§€ì , ì´ ${totalDispatchedQuantity}ê°œ)`,
      };

      const updateData = removeUndefinedValues({
        currentStatus: 'partial_dispatched',
        currentResponsibleTeam: 'logistics',
        branchDispatchQuantities: cleanedBranchDispatchQuantities,
        dispatchMemo: dispatchMemo,
        statusHistory: arrayUnion(newHistoryEntry),
        updatedAt: Timestamp.now(),
      });

      console.log('ğŸ”¥ Firestore ì—…ë°ì´íŠ¸ ë°ì´í„°:', updateData);

      await updateDoc(requestRef, updateData);

      console.log('âœ… Firestore ì—…ë°ì´íŠ¸ ì„±ê³µ');

      setComment('');
      setDispatchMemo('');
      onUpdate();
      onClose();
      
    } catch (error) {
      console.error('âŒ ë¶€ë¶„ ì¶œê³  ì €ì¥ ì‹¤íŒ¨:', error);
      setError('ë¶€ë¶„ ì¶œê³  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setProcessing(false);
    }
  };

  if (!request) return null;

  // ê¶Œí•œ ì²´í¬: ë¬¼ë¥˜íŒ€ì´ë‚˜ ê´€ë¦¬ìë§Œ ìƒíƒœ ë³€ê²½ ê°€ëŠ¥
  const canChangeStatus = userProfile?.role === 'logistics' || userProfile?.role === 'admin';
  const canConfirmReceipt = userProfile?.role === 'operations' || userProfile?.role === 'admin';

  // í¸ì§‘ ì„¹ì…˜ ì œëª© ë§¤í•‘
  const getEditSectionTitle = (section: string) => {
    switch (section) {
      case 'ecount': return 'ì´ì¹´ìš´íŠ¸ ë“±ë¡ ìˆ˜ì •';
      case 'po': return 'êµ¬ë§¤ì²˜ ë°œì£¼ ìˆ˜ì •';
      case 'warehouse': return 'ë¬¼ë¥˜ì°½ê³  ì…ê³  ìˆ˜ì •';
      case 'dispatch': return 'ì§€ì  ì¶œê³  ìˆ˜ì •';
      case 'receipt': return 'ì§€ì  ì…ê³  í™•ì¸ ìˆ˜ì •';
      default: return 'ìƒíƒœ ìˆ˜ì •';
    }
  };

  return (
    <LocalizationProvider dateAdapter={AdapterDateFns}>
      <Dialog open={open} onClose={onClose} maxWidth="lg" fullWidth>
        <DialogTitle>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Typography variant="h6">
              {editMode && editSection 
                ? `${getEditSectionTitle(editSection)} - ${request?.requestId}`
                : `êµ¬ë§¤ ìš”ì²­ ìƒì„¸ ì •ë³´ - ${request?.requestId}`
              }
            </Typography>
            <IconButton onClick={onClose}>
              <CloseIcon />
            </IconButton>
          </Box>
        </DialogTitle>

        <DialogContent>
          {error && (
            <Alert severity="error" sx={{ mb: 2 }} onClose={() => setError('')}>
              {error}
            </Alert>
          )}

          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
            {/* í¸ì§‘ ëª¨ë“œì¼ ë•Œ ìš”ì•½ ì •ë³´ í‘œì‹œ */}
            {editMode && (
              <Card>
                <CardContent>
                  <Typography variant="h6" gutterBottom>
                    ğŸ“‹ ìš”ì²­ ì •ë³´ ìš”ì•½
                  </Typography>
                  <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 2 }}>
                    <Box>
                      <Typography variant="body2" color="text.secondary">ìš”ì²­ ID</Typography>
                      <Typography variant="body1" fontWeight="medium">{request.requestId}</Typography>
                    </Box>
                    <Box>
                      <Typography variant="body2" color="text.secondary">ë¶€í’ˆëª…</Typography>
                      <Typography variant="body1">{request.requestedPartName}</Typography>
                    </Box>
                    <Box>
                      <Typography variant="body2" color="text.secondary">ì´ ìš”ì²­ìˆ˜ëŸ‰</Typography>
                      <Typography variant="h6" color="primary">{request.totalRequestedQuantity.toLocaleString()}ê°œ</Typography>
                    </Box>
                  </Box>
                </CardContent>
              </Card>
            )}

            {/* í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ê¸°ë³¸ ì •ë³´ë“¤ í‘œì‹œ */}
            {!editMode && (
              <>
                {/* ê¸°ë³¸ ì •ë³´ */}
                <Card>
                  <CardContent>
                    <Typography variant="h6" gutterBottom>
                      ğŸ“‹ ìš”ì²­ ê¸°ë³¸ ì •ë³´
                    </Typography>
                    <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2 }}>
                      <Box>
                        <Typography variant="body2" color="text.secondary">ìš”ì²­ ID</Typography>
                        <Typography variant="body1" fontWeight="medium">{request.requestId}</Typography>
                      </Box>
                      <Box>
                        <Typography variant="body2" color="text.secondary">ìš”ì²­ì¼</Typography>
                        <Typography variant="body1">{request.requestDate.toLocaleDateString('ko-KR')}</Typography>
                      </Box>
                      <Box>
                        <Typography variant="body2" color="text.secondary">ìš”ì²­ì</Typography>
                        <Typography variant="body1">{request.requestorName}</Typography>
                      </Box>
                      <Box>
                        <Typography variant="body2" color="text.secondary">ì¤‘ìš”ë„</Typography>
                        <Chip
                          label={getImportanceLabel(request.importance)}
                          color={getImportanceColor(request.importance) as any}
                          size="small"
                        />
                      </Box>
                      <Box>
                        <Typography variant="body2" color="text.secondary">í˜„ì¬ ìƒíƒœ</Typography>
                        <Chip
                          label={getStatusLabel(request.currentStatus)}
                          color={getStatusColor(request.currentStatus) as any}
                          size="small"
                        />
                      </Box>
                      <Box>
                        <Typography variant="body2" color="text.secondary">ì´ ìš”ì²­ìˆ˜ëŸ‰</Typography>
                        <Typography variant="h6" color="primary">{request.totalRequestedQuantity.toLocaleString()}ê°œ</Typography>
                      </Box>
                    </Box>
                    
                    {/* ê¸°ì¡´ ìš”ì²­ ë©”ëª¨ê°€ ìˆë‹¤ë©´ í‘œì‹œ */}
                    {request.notes && (
                      <Box sx={{ mt: 3 }}>
                        <Typography variant="body2" color="text.secondary" gutterBottom>
                          ìš”ì²­ ë©”ëª¨
                        </Typography>
                        <Typography variant="body1" sx={{ p: 2, bgcolor: 'grey.50', borderRadius: 1 }}>
                          {request.notes}
                        </Typography>
                      </Box>
                    )}
                  </CardContent>
                </Card>

                {/* ë¶€í’ˆ ì •ë³´ */}
                <Card>
                  <CardHeader
                    title="ğŸ”§ ë¶€í’ˆ ì •ë³´"
                    action={
                      <IconButton
                        onClick={() => toggleSection('partInfo')}
                        sx={{ transform: expandedSections.partInfo ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.3s' }}
                      >
                        <ExpandMoreIcon />
                      </IconButton>
                    }
                    sx={{ pb: 1 }}
                  />
                  <Collapse in={expandedSections.partInfo}>
                    <CardContent sx={{ pt: 0 }}>
                      <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2 }}>
                        <Box>
                          <Typography variant="body2" color="text.secondary">ë¶€í’ˆë²ˆí˜¸</Typography>
                          <Typography variant="body1" fontWeight="medium">{request.requestedPartNumber}</Typography>
                        </Box>
                        <Box>
                          <Typography variant="body2" color="text.secondary">ë¶€í’ˆëª…</Typography>
                          <Typography variant="body1" fontWeight="medium">{request.requestedPartName}</Typography>
                        </Box>
                        <Box>
                          <Typography variant="body2" color="text.secondary">íŒë§¤ê°€</Typography>
                          <Typography variant="body1" fontWeight="medium" color="success.main">
                            {request.price ? `${request.price.toLocaleString()}ì›` : 'ë¯¸ì…ë ¥'}
                          </Typography>
                        </Box>
                        <Box>
                          <Typography variant="body2" color="text.secondary">í’ˆëª©ê·¸ë£¹ 1</Typography>
                          <Typography variant="body1">
                            {request.itemGroup1 || 'ë¯¸ì…ë ¥'}
                          </Typography>
                        </Box>
                        <Box>
                          <Typography variant="body2" color="text.secondary">í’ˆëª©ê·¸ë£¹ 2</Typography>
                          <Typography variant="body1">
                            {request.itemGroup2 || 'ë¯¸ì…ë ¥'}
                          </Typography>
                        </Box>
                        <Box>
                          <Typography variant="body2" color="text.secondary">í’ˆëª©ê·¸ë£¹ 3</Typography>
                          <Typography variant="body1">
                            {request.itemGroup3 || 'ë¯¸ì…ë ¥'}
                          </Typography>
                        </Box>
                        <Box sx={{ gridColumn: '1 / -1' }}>
                          <Typography variant="body2" color="text.secondary">ì¶”ì²œ êµ¬ë§¤ì²˜</Typography>
                          <Typography variant="body1">{request.initialSupplier || 'ë¯¸ì§€ì •'}</Typography>
                        </Box>
                        {request.actualSupplier && (
                          <Box sx={{ gridColumn: '1 / -1' }}>
                            <Typography variant="body2" color="text.secondary">ì‹¤ì œ ë°œì£¼ì²˜</Typography>
                            <Typography variant="body1" fontWeight="medium">{request.actualSupplier}</Typography>
                          </Box>
                        )}
                      </Box>
                    </CardContent>
                  </Collapse>
                </Card>

                {/* ì§€ì ë³„ ìš”ì²­ìˆ˜ëŸ‰ */}
                {/* ì§€ì  ì¶œê³  ì²˜ë¦¬ í™”ë©´ì´ ì•„ë‹ ë•Œë§Œ ìƒì„¸ í…Œì´ë¸” í‘œì‹œ */}
                {!((!editMode && canChangeStatus && (request.currentStatus === 'warehouse_received' || request.currentStatus === 'partial_dispatched')) ||
                  (editMode && editSection === 'dispatch')) ? (
                  <Card>
                    <CardHeader
                      title="ğŸª ì§€ì ë³„ ìš”ì²­ìˆ˜ëŸ‰"
                      action={
                        <IconButton
                          onClick={() => toggleSection('branchInfo')}
                          sx={{ transform: expandedSections.branchInfo ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.3s' }}
                        >
                          <ExpandMoreIcon />
                        </IconButton>
                      }
                      sx={{ pb: 1 }}
                    />
                    <Collapse in={expandedSections.branchInfo}>
                      <CardContent sx={{ pt: 0 }}>
                        <TableContainer component={Paper} variant="outlined">
                          <Table size="small">
                            <TableHead>
                              <TableRow>
                                <TableCell>ì§€ì ëª…</TableCell>
                                <TableCell>ìš”ì²­ìˆ˜ëŸ‰</TableCell>
                                {request.branchDispatchQuantities && (
                                  <>
                                    <TableCell>ì¶œê³ ìˆ˜ëŸ‰</TableCell>
                                    {request.branchDispatchQuantities.some(item => item.confirmedQuantity !== undefined) && (
                                      <TableCell>ìˆ˜ë ¹ìˆ˜ëŸ‰</TableCell>
                                    )}
                                  </>
                                )}
                              </TableRow>
                            </TableHead>
                            <TableBody>
                              {request.branchRequirements.map((req, index) => {
                                const dispatchInfo = request.branchDispatchQuantities?.find(
                                  item => item.branchId === req.branchId
                                );
                                return (
                                  <TableRow key={index}>
                                    <TableCell>{req.branchName}</TableCell>
                                    <TableCell>{Number(req.requestedQuantity).toLocaleString()}ê°œ</TableCell>
                                    {request.branchDispatchQuantities && (
                                      <>
                                        <TableCell>
                                          {dispatchInfo?.dispatchedQuantity?.toLocaleString() || '0'}ê°œ
                                        </TableCell>
                                        {request.branchDispatchQuantities.some(item => item.confirmedQuantity !== undefined) && (
                                          <TableCell>
                                            {dispatchInfo?.confirmedQuantity?.toLocaleString() || '0'}ê°œ
                                          </TableCell>
                                        )}
                                      </>
                                    )}
                                  </TableRow>
                                );
                              })}
                              <TableRow>
                                <TableCell sx={{ fontWeight: 'bold' }}>ë¬¼ë¥˜ ì ì •ì¬ê³ </TableCell>
                                <TableCell sx={{ fontWeight: 'bold' }}>
                                  {request.logisticsStockQuantity.toLocaleString()}ê°œ
                                </TableCell>
                                {request.branchDispatchQuantities && (
                                  <>
                                    <TableCell sx={{ fontWeight: 'bold' }}>-</TableCell>
                                    {request.branchDispatchQuantities.some(item => item.confirmedQuantity !== undefined) && (
                                      <TableCell sx={{ fontWeight: 'bold', fontSize: '1.1rem', color: 'primary.main' }}>
                                        {request.branchDispatchQuantities.reduce((sum, item) => sum + (item.confirmedQuantity || 0), 0).toLocaleString()}ê°œ
                                      </TableCell>
                                    )}
                                  </>
                                )}
                              </TableRow>
                              <TableRow>
                                <TableCell sx={{ fontWeight: 'bold', fontSize: '1.1rem' }}>ì´ê³„</TableCell>
                                <TableCell sx={{ fontWeight: 'bold', fontSize: '1.1rem', color: 'primary.main' }}>
                                  {request.totalRequestedQuantity.toLocaleString()}ê°œ
                                </TableCell>
                                {request.branchDispatchQuantities && (
                                  <>
                                    <TableCell sx={{ fontWeight: 'bold', fontSize: '1.1rem', color: 'primary.main' }}>
                                      {request.branchDispatchQuantities.reduce((sum, item) => sum + item.dispatchedQuantity, 0).toLocaleString()}ê°œ
                                    </TableCell>
                                    {request.branchDispatchQuantities.some(item => item.confirmedQuantity !== undefined) && (
                                      <TableCell sx={{ fontWeight: 'bold', fontSize: '1.1rem', color: 'primary.main' }}>
                                        {request.branchDispatchQuantities.reduce((sum, item) => sum + (item.confirmedQuantity || 0), 0).toLocaleString()}ê°œ
                                      </TableCell>
                                    )}
                                  </>
                                )}
                              </TableRow>
                            </TableBody>
                          </Table>
                        </TableContainer>
                      </CardContent>
                    </Collapse>
                  </Card>
                ) : (
                  // ì§€ì  ì¶œê³  ì²˜ë¦¬ í™”ë©´ì—ì„œëŠ” ê°„ë‹¨í•œ ìš”ì•½ë§Œ í‘œì‹œ
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        ğŸ“Š ìš”ì²­ ìˆ˜ëŸ‰ ìš”ì•½
                      </Typography>
                      <Box sx={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 2 }}>
                        <Box sx={{ textAlign: 'center', p: 2, bgcolor: 'primary.50', borderRadius: 1 }}>
                          <Typography variant="body2" color="text.secondary">ì´ ìš”ì²­ìˆ˜ëŸ‰</Typography>
                          <Typography variant="h5" color="primary.main" fontWeight="bold">
                            {request.totalRequestedQuantity.toLocaleString()}ê°œ
                          </Typography>
                        </Box>
                        <Box sx={{ textAlign: 'center', p: 2, bgcolor: 'success.50', borderRadius: 1 }}>
                          <Typography variant="body2" color="text.secondary">ì§€ì  ìš”ì²­</Typography>
                          <Typography variant="h6" color="success.main" fontWeight="bold">
                            {request.branchRequirements.length}ê°œ ì§€ì 
                          </Typography>
                        </Box>
                        <Box sx={{ textAlign: 'center', p: 2, bgcolor: 'info.50', borderRadius: 1 }}>
                          <Typography variant="body2" color="text.secondary">ë¬¼ë¥˜ ì ì •ì¬ê³ </Typography>
                          <Typography variant="h6" color="info.main" fontWeight="bold">
                            {request.logisticsStockQuantity.toLocaleString()}ê°œ
                          </Typography>
                        </Box>
                        {request.actualReceivedQuantity && (
                          <Box sx={{ textAlign: 'center', p: 2, bgcolor: 'warning.50', borderRadius: 1 }}>
                            <Typography variant="body2" color="text.secondary">ì°½ê³  ë³´ìœ </Typography>
                            <Typography variant="h6" color="warning.main" fontWeight="bold">
                              {request.actualReceivedQuantity.toLocaleString()}ê°œ
                            </Typography>
                          </Box>
                        )}
                      </Box>
                    </CardContent>
                  </Card>
                )}

                {/* Phase 2: ì§„í–‰ ìƒì„¸ ì •ë³´ */}
                <Card>
                  <CardHeader
                    title="ğŸ“ˆ ì§„í–‰ ìƒì„¸ ì •ë³´"
                    action={
                      <IconButton
                        onClick={() => toggleSection('progressInfo')}
                        sx={{ transform: expandedSections.progressInfo ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.3s' }}
                      >
                        <ExpandMoreIcon />
                      </IconButton>
                    }
                    sx={{ pb: 1 }}
                  />
                  <Collapse in={expandedSections.progressInfo}>
                    <CardContent sx={{ pt: 0 }}>
                      <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                        {/* í˜„ì¬ ì§„í–‰ ìƒíƒœ ì •ë³´ */}
                        <Box sx={{ p: 2, bgcolor: 'info.50', borderRadius: 1 }}>
                          <Typography variant="subtitle2" fontWeight="medium" color="info.main">
                            í˜„ì¬ ì§„í–‰ ë‹¨ê³„: {getStatusLabel(request.currentStatus)}
                          </Typography>
                          <Typography variant="body2" color="text.secondary" sx={{ mt: 0.5 }}>
                            {request.currentStatus === 'operations_submitted' && 'ë¬¼ë¥˜íŒ€ ì´ì¹´ìš´íŠ¸ ë“±ë¡ ëŒ€ê¸° ì¤‘'}
                            {request.currentStatus === 'ecount_registered' && 'ë¬¼ë¥˜íŒ€ êµ¬ë§¤ì²˜ ë°œì£¼ ì§„í–‰ ì¤‘'}
                            {request.currentStatus === 'po_completed' && 'êµ¬ë§¤ì²˜ ë‚©í’ˆ í›„ ë¬¼ë¥˜ì°½ê³  ì…ê³  ëŒ€ê¸° ì¤‘'}
                            {request.currentStatus === 'warehouse_received' && 'ë¬¼ë¥˜íŒ€ ì§€ì  ì¶œê³  ì¤€ë¹„ ì¤‘'}
                            {request.currentStatus === 'partial_dispatched' && 'ì¼ë¶€ ì§€ì  ì¶œê³  ì™„ë£Œ, ë‚˜ë¨¸ì§€ ì¶œê³  ì§„í–‰ ì¤‘'}
                            {request.currentStatus === 'branch_dispatched' && 'ìš´ì˜íŒ€ ì§€ì  ì…ê³  í™•ì¸ ëŒ€ê¸° ì¤‘'}
                            {request.currentStatus === 'branch_received_confirmed' && 'ëª¨ë“  ì ˆì°¨ ì™„ë£Œ'}
                          </Typography>
                        </Box>

                        {/* ë‹¨ê³„ë³„ ìƒì„¸ ì •ë³´ */}
                        <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2 }}>
                          {/* êµ¬ë§¤ì²˜ ë°œì£¼ ì •ë³´ */}
                          {request.expectedDeliveryDate && (
                            <>
                              <Box>
                                <Typography variant="body2" color="text.secondary">ì…ê³  ì˜ˆì •ì¼</Typography>
                                <Typography variant="body1">{request.expectedDeliveryDate.toLocaleDateString('ko-KR')}</Typography>
                              </Box>
                              <Box>
                                <Typography variant="body2" color="text.secondary">ì…ê³  ì˜ˆì • ìˆ˜ëŸ‰</Typography>
                                <Typography variant="body1">{request.expectedDeliveryQuantity?.toLocaleString()}ê°œ</Typography>
                              </Box>
                            </>
                          )}
                          
                          {/* ë¬¼ë¥˜ì°½ê³  ì…ê³  ì •ë³´ */}
                          {request.actualReceivedQuantity && (
                            <>
                              <Box>
                                <Typography variant="body2" color="text.secondary">ì‹¤ì œ ì…ê³ ì¼</Typography>
                                <Typography variant="body1">{request.warehouseReceiptAt?.toLocaleDateString('ko-KR')}</Typography>
                              </Box>
                              <Box>
                                <Typography variant="body2" color="text.secondary">ì‹¤ì œ ì…ê³  ìˆ˜ëŸ‰</Typography>
                                <Typography variant="body1" fontWeight="medium" color="primary.main">
                                  {request.actualReceivedQuantity.toLocaleString()}ê°œ
                                </Typography>
                              </Box>
                            </>
                          )}

                          {/* ì¶œê³  ì§„í–‰ í˜„í™© */}
                          {request.branchDispatchQuantities && request.branchDispatchQuantities.length > 0 && (
                            <>
                              <Box>
                                <Typography variant="body2" color="text.secondary">ì¶œê³  ì™„ë£Œ ì§€ì </Typography>
                                <Typography variant="body1" color="success.main">
                                  {request.branchDispatchQuantities.filter(item => item.isDispatched).length} / {request.branchDispatchQuantities.length} ì§€ì 
                                </Typography>
                              </Box>
                              <Box>
                                <Typography variant="body2" color="text.secondary">ì´ ì¶œê³  ìˆ˜ëŸ‰</Typography>
                                <Typography variant="body1" color="primary.main">
                                  {request.branchDispatchQuantities.reduce((sum, item) => sum + (item.isDispatched ? item.dispatchedQuantity : 0), 0).toLocaleString()}ê°œ
                                </Typography>
                              </Box>
                            </>
                          )}
                        </Box>

                        {/* ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´ */}
                        {request.currentStatus !== 'branch_received_confirmed' && (
                          <Box sx={{ p: 2, bgcolor: 'grey.50', borderRadius: 1, borderLeft: '4px solid', borderColor: 'primary.main' }}>
                            <Typography variant="body2" fontWeight="medium" gutterBottom>
                              ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„
                            </Typography>
                            <Typography variant="body2" color="text.secondary">
                              {request.currentStatus === 'operations_submitted' && 'ë¬¼ë¥˜íŒ€ì—ì„œ ì´ì¹´ìš´íŠ¸ ERP ì‹œìŠ¤í…œì— ë¶€í’ˆì„ ë“±ë¡í•©ë‹ˆë‹¤.'}
                              {request.currentStatus === 'ecount_registered' && 'ë¬¼ë¥˜íŒ€ì—ì„œ êµ¬ë§¤ì²˜ì— ë°œì£¼í•˜ê³  ì…ê³  ì˜ˆì •ì¼ì„ ì„¤ì •í•©ë‹ˆë‹¤.'}
                              {request.currentStatus === 'po_completed' && 'êµ¬ë§¤ì²˜ì—ì„œ ë‚©í’ˆí•˜ë©´ ë¬¼ë¥˜ì°½ê³ ì—ì„œ ì…ê³  ì²˜ë¦¬í•©ë‹ˆë‹¤.'}
                              {request.currentStatus === 'warehouse_received' && 'ë¬¼ë¥˜íŒ€ì—ì„œ ê° ì§€ì ìœ¼ë¡œ ì¶œê³  ì²˜ë¦¬í•©ë‹ˆë‹¤.'}
                              {request.currentStatus === 'partial_dispatched' && 'ë¬¼ë¥˜íŒ€ì—ì„œ ë‚˜ë¨¸ì§€ ì§€ì  ì¶œê³ ë¥¼ ì™„ë£Œí•©ë‹ˆë‹¤.'}
                              {request.currentStatus === 'branch_dispatched' && 'ìš´ì˜íŒ€ì—ì„œ ê° ì§€ì ì˜ ì…ê³ ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.'}
                            </Typography>
                          </Box>
                        )}
                      </Box>
                    </CardContent>
                  </Collapse>
                </Card>

                {/* ìš”ì²­ ë©”ëª¨ */}
                <Card>
                  <CardHeader
                    title="ğŸ“ ìš”ì²­ ë©”ëª¨"
                    action={
                      <IconButton
                        onClick={() => toggleSection('memo')}
                        sx={{ transform: expandedSections.memo ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.3s' }}
                      >
                        <ExpandMoreIcon />
                      </IconButton>
                    }
                    sx={{ pb: 1 }}
                  />
                  <Collapse in={expandedSections.memo}>
                    <CardContent sx={{ pt: 0 }}>
                      {request.notes && (
                        <Box sx={{ mb: 2 }}>
                          <Typography variant="body2" color="text.secondary" gutterBottom>
                            ê¸°ì¡´ ìš”ì²­ ë©”ëª¨
                          </Typography>
                          <Typography variant="body1" sx={{ p: 2, bgcolor: 'grey.50', borderRadius: 1 }}>
                            {request.notes}
                          </Typography>
                        </Box>
                      )}
                      <TextField
                        fullWidth
                        multiline
                        rows={4}
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="ìš”ì²­ì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                      />
                    </CardContent>
                  </Collapse>
                </Card>

                {/* ì²˜ë¦¬ íˆìŠ¤í† ë¦¬ */}
                <Card>
                  <CardHeader
                    title="ğŸ“œ ì²˜ë¦¬ íˆìŠ¤í† ë¦¬"
                    action={
                      <IconButton
                        onClick={() => toggleSection('history')}
                        sx={{ transform: expandedSections.history ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.3s' }}
                      >
                        <ExpandMoreIcon />
                      </IconButton>
                    }
                    sx={{ pb: 1 }}
                  />
                  <Collapse in={expandedSections.history}>
                    <CardContent sx={{ pt: 0 }}>
                      <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                        {request.statusHistory && request.statusHistory.length > 0 ? (
                          request.statusHistory
                            .slice()
                            .reverse()
                            .map((history, index) => (
                              <Box key={index} sx={{ p: 2, border: '1px solid', borderColor: 'grey.300', borderRadius: 1 }}>
                                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 1 }}>
                                  <Chip
                                    label={getStatusLabel(history.status)}
                                    color={getStatusColor(history.status) as any}
                                    size="small"
                                  />
                                  <Typography variant="body2" color="text.secondary">
                                    {history.updatedAt.toLocaleDateString('ko-KR')} {history.updatedAt.toLocaleTimeString('ko-KR')}
                                  </Typography>
                                </Box>
                                <Typography variant="body2" color="text.secondary" gutterBottom>
                                  ì²˜ë¦¬ì: {history.updatedByName}
                                </Typography>
                                <Typography variant="body1">
                                  {history.comments}
                                </Typography>
                              </Box>
                            ))
                        ) : (
                          <Typography variant="body2" color="text.secondary" textAlign="center">
                            ì²˜ë¦¬ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.
                          </Typography>
                        )}
                      </Box>
                    </CardContent>
                  </Collapse>
                </Card>

                {/* í¸ì§‘ ëª¨ë“œì—ì„œ íŠ¹ì • ì„¹ì…˜ë³„ ì…ë ¥ í¼ */}
                {editMode && editSection === 'ecount' && (
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        ğŸ·ï¸ ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì •ë³´
                      </Typography>
                      
                      {/* ë¶€í’ˆ ì •ë³´ ìš”ì•½ */}
                      <Box sx={{ mb: 3, p: 2, bgcolor: 'info.50', borderRadius: 1 }}>
                        <Typography variant="subtitle2" fontWeight="medium" color="info.main" gutterBottom>
                          ğŸ“¦ ë¶€í’ˆ ì •ë³´
                        </Typography>
                        <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2 }}>
                          <Box>
                            <Typography variant="body2" color="text.secondary">ë¶€í’ˆë²ˆí˜¸</Typography>
                            <Typography variant="body1" fontWeight="medium">{request.requestedPartNumber}</Typography>
                          </Box>
                          <Box>
                            <Typography variant="body2" color="text.secondary">ë¶€í’ˆëª…</Typography>
                            <Typography variant="body1" fontWeight="medium">{request.requestedPartName}</Typography>
                          </Box>
                          <Box>
                            <Typography variant="body2" color="text.secondary">íŒë§¤ê°€</Typography>
                            <Typography variant="body1" fontWeight="medium" color="success.main">
                              {request.price ? `${request.price.toLocaleString()}ì›` : 'ë¯¸ì…ë ¥'}
                            </Typography>
                          </Box>
                          <Box>
                            <Typography variant="body2" color="text.secondary">ì¶”ì²œ êµ¬ë§¤ì²˜</Typography>
                            <Typography variant="body1">{request.initialSupplier || 'ë¯¸ì§€ì •'}</Typography>
                          </Box>
                        </Box>
                      </Box>

                      <Alert severity="info" sx={{ mb: 2 }}>
                        âœ… ìš´ì˜ë¶€ì„œ ì…ë ¥ ì •ë³´ê°€ ë¨¼ì € í‘œì‹œë©ë‹ˆë‹¤. í•„ìš”ì‹œì—ë§Œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.
                      </Alert>
                      <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 2, mb: 2 }}>
                        <TextField
                          label="í’ˆëª©ê·¸ë£¹ 1"
                          value={itemGroup1}
                          onChange={(e) => setItemGroup1(e.target.value)}
                          required
                          error={!itemGroup1.trim()}
                          helperText={!itemGroup1.trim() ? 'í•„ìˆ˜ ì…ë ¥' : 'ìš´ì˜ë¶€ì„œ ì…ë ¥ ì •ë³´'}
                        />
                        <TextField
                          label="í’ˆëª©ê·¸ë£¹ 2"
                          value={itemGroup2}
                          onChange={(e) => setItemGroup2(e.target.value)}
                          required
                          error={!itemGroup2.trim()}
                          helperText={!itemGroup2.trim() ? 'í•„ìˆ˜ ì…ë ¥' : 'ìš´ì˜ë¶€ì„œ ì…ë ¥ ì •ë³´'}
                        />
                        <TextField
                          label="í’ˆëª©ê·¸ë£¹ 3"
                          value={itemGroup3}
                          onChange={(e) => setItemGroup3(e.target.value)}
                          required
                          error={!itemGroup3.trim()}
                          helperText={!itemGroup3.trim() ? 'í•„ìˆ˜ ì…ë ¥' : 'ìš´ì˜ë¶€ì„œ ì…ë ¥ ì •ë³´'}
                        />
                      </Box>
                      <TextField
                        fullWidth
                        multiline
                        rows={3}
                        label="ìˆ˜ì • ì‚¬ìœ "
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ëŠ” ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                        sx={{ mb: 2 }}
                      />
                    </CardContent>
                  </Card>
                )}

                {editMode && editSection === 'po' && (
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        ğŸ›’ êµ¬ë§¤ì²˜ ë°œì£¼ ì •ë³´ ìˆ˜ì •
                      </Typography>
                      <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2, mb: 2 }}>
                        <DatePicker
                          label="ì…ê³  ì˜ˆì •ì¼"
                          value={expectedDeliveryDate}
                          onChange={(newValue) => setExpectedDeliveryDate(newValue)}
                        />
                        <TextField
                          label="ì…ê³  ì˜ˆì • ìˆ˜ëŸ‰"
                          type="number"
                          value={expectedDeliveryQuantity}
                          onChange={(e) => setExpectedDeliveryQuantity(Number(e.target.value))}
                          InputProps={{ endAdornment: 'ê°œ' }}
                        />
                        <TextField
                          label="ì‹¤ì œ ë°œì£¼ì²˜"
                          value={actualSupplier}
                          onChange={(e) => setActualSupplier(e.target.value)}
                          placeholder={request.initialSupplier || 'êµ¬ë§¤ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”'}
                        />
                        <TextField
                          label="ë°œì£¼ ë©”ëª¨"
                          value={poMemo}
                          onChange={(e) => setPoMemo(e.target.value)}
                          placeholder="ë°œì£¼ ê´€ë ¨ ë©”ëª¨"
                        />
                      </Box>
                      <TextField
                        fullWidth
                        multiline
                        rows={3}
                        label="ìˆ˜ì • ì‚¬ìœ "
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="êµ¬ë§¤ì²˜ ë°œì£¼ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ëŠ” ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                        required
                      />
                    </CardContent>
                  </Card>
                )}

                {editMode && editSection === 'warehouse' && (
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        ğŸ“¦ ë¬¼ë¥˜ì°½ê³  ì…ê³  ì •ë³´ ìˆ˜ì •
                      </Typography>
                      <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2, mb: 2 }}>
                        <DatePicker
                          label="ì‹¤ì œ ì…ê³ ì¼"
                          value={actualReceiptDate}
                          onChange={(newValue) => setActualReceiptDate(newValue)}
                        />
                        <TextField
                          label="ì‹¤ì œ ì…ê³  ìˆ˜ëŸ‰"
                          type="number"
                          value={actualReceivedQuantity}
                          onChange={(e) => setActualReceivedQuantity(Number(e.target.value))}
                          InputProps={{ endAdornment: 'ê°œ' }}
                        />
                        <TextField
                          label="ì…ê³  ë©”ëª¨"
                          value={warehouseReceiptMemo}
                          onChange={(e) => setWarehouseReceiptMemo(e.target.value)}
                          placeholder="ì…ê³  ê´€ë ¨ ë©”ëª¨"
                          sx={{ gridColumn: '1 / -1' }}
                        />
                      </Box>
                      <TextField
                        fullWidth
                        multiline
                        rows={3}
                        label="ìˆ˜ì • ì‚¬ìœ "
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="ë¬¼ë¥˜ì°½ê³  ì…ê³  ì •ë³´ë¥¼ ìˆ˜ì •í•˜ëŠ” ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                        required
                      />
                    </CardContent>
                  </Card>
                )}

                {editMode && editSection === 'dispatch' && (
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        ğŸšš ì§€ì  ì¶œê³  ì •ë³´ ìˆ˜ì •
                      </Typography>
                      <Box sx={{ mb: 2 }}>
                        <Typography variant="body2" color="text.secondary" gutterBottom>
                          ì§€ì ë³„ ì¶œê³  ìˆ˜ëŸ‰ ìˆ˜ì •
                        </Typography>
                        {branchDispatchQuantities.map((branch, index) => (
                          <Box key={index} sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1 }}>
                            <Typography variant="body2" sx={{ minWidth: 120 }}>
                              {branch.branchName}
                            </Typography>
                            <TextField
                              type="number"
                              size="small"
                              value={branch.dispatchedQuantity}
                              onChange={(e) => handleBranchDispatchQuantityChange(index, Number(e.target.value))}
                              InputProps={{ endAdornment: 'ê°œ' }}
                              sx={{ width: 150 }}
                            />
                            {branch.isDispatched && (
                              <Chip label="ì¶œê³ ì™„ë£Œ" color="success" size="small" />
                            )}
                          </Box>
                        ))}
                        <TextField
                          label="ì¶œê³  ë©”ëª¨"
                          value={dispatchMemo}
                          onChange={(e) => setDispatchMemo(e.target.value)}
                          placeholder="ì¶œê³  ê´€ë ¨ ë©”ëª¨"
                          fullWidth
                          sx={{ mt: 2 }}
                        />
                      </Box>
                      <TextField
                        fullWidth
                        multiline
                        rows={3}
                        label="ìˆ˜ì • ì‚¬ìœ "
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="ì§€ì  ì¶œê³  ì •ë³´ë¥¼ ìˆ˜ì •í•˜ëŠ” ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                      />
                    </CardContent>
                  </Card>
                )}

                {editMode && editSection === 'receipt' && (
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        âœ… ì§€ì  ì…ê³  í™•ì¸ ì •ë³´ ìˆ˜ì •
                      </Typography>
                      <Box sx={{ mb: 2 }}>
                        <Typography variant="body2" color="text.secondary" gutterBottom>
                          ì§€ì ë³„ ìˆ˜ë ¹ ìˆ˜ëŸ‰ ë° ë©”ëª¨ ìˆ˜ì •
                        </Typography>
                        {branchReceiptQuantities.map((branch, index) => (
                          <Box key={index} sx={{ p: 2, border: '1px solid', borderColor: 'grey.300', borderRadius: 1, mb: 2 }}>
                            <Typography variant="body2" fontWeight="medium" gutterBottom>
                              {branch.branchName}
                            </Typography>
                            <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2 }}>
                              <TextField
                                label="ì¶œê³  ìˆ˜ëŸ‰"
                                value={branch.dispatchedQuantity}
                                InputProps={{ endAdornment: 'ê°œ', readOnly: true }}
                                size="small"
                              />
                              <TextField
                                label="ìˆ˜ë ¹ ìˆ˜ëŸ‰"
                                type="number"
                                value={branch.confirmedQuantity || 0}
                                onChange={(e) => handleBranchReceiptQuantityChange(index, Number(e.target.value))}
                                InputProps={{ endAdornment: 'ê°œ' }}
                                size="small"
                              />
                            </Box>
                            <TextField
                              label="ìˆ˜ë ¹ ë©”ëª¨"
                              value={branch.branchReceiptMemo || ''}
                              onChange={(e) => handleBranchReceiptMemoChange(index, e.target.value)}
                              placeholder="ì§€ì  ìˆ˜ë ¹ ê´€ë ¨ ë©”ëª¨"
                              fullWidth
                              size="small"
                              sx={{ mt: 1 }}
                            />
                          </Box>
                        ))}
                      </Box>
                      <TextField
                        fullWidth
                        multiline
                        rows={3}
                        label="ìˆ˜ì • ì‚¬ìœ "
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="ì§€ì  ì…ê³  í™•ì¸ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ëŠ” ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                        required
                      />
                    </CardContent>
                  </Card>
                )}

                {/* ì¼ë°˜ ëª¨ë“œì—ì„œ ìƒíƒœë³„ ì•¡ì…˜ í¼ */}
                {!editMode && canChangeStatus && request.currentStatus === 'operations_submitted' && (
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        ğŸ·ï¸ ì´ì¹´ìš´íŠ¸ ë“±ë¡
                      </Typography>
                      
                      {/* ë¶€í’ˆ ì •ë³´ ìš”ì•½ */}
                      <Box sx={{ mb: 3, p: 2, bgcolor: 'info.50', borderRadius: 1 }}>
                        <Typography variant="subtitle2" fontWeight="medium" color="info.main" gutterBottom>
                          ğŸ“¦ ë¶€í’ˆ ì •ë³´
                        </Typography>
                        <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2 }}>
                          <Box>
                            <Typography variant="body2" color="text.secondary">ë¶€í’ˆë²ˆí˜¸</Typography>
                            <Typography variant="body1" fontWeight="medium">{request.requestedPartNumber}</Typography>
                          </Box>
                          <Box>
                            <Typography variant="body2" color="text.secondary">ë¶€í’ˆëª…</Typography>
                            <Typography variant="body1" fontWeight="medium">{request.requestedPartName}</Typography>
                          </Box>
                          <Box>
                            <Typography variant="body2" color="text.secondary">íŒë§¤ê°€</Typography>
                            <Typography variant="body1" fontWeight="medium" color="success.main">
                              {request.price ? `${request.price.toLocaleString()}ì›` : 'ë¯¸ì…ë ¥'}
                            </Typography>
                          </Box>
                          <Box>
                            <Typography variant="body2" color="text.secondary">ì¶”ì²œ êµ¬ë§¤ì²˜</Typography>
                            <Typography variant="body1">{request.initialSupplier || 'ë¯¸ì§€ì •'}</Typography>
                          </Box>
                        </Box>
                      </Box>

                      <Alert severity="success" sx={{ mb: 2 }}>
                        âœ… ìš´ì˜ë¶€ì„œ ì…ë ¥ ì •ë³´ê°€ ë¨¼ì € í‘œì‹œë©ë‹ˆë‹¤. í•„ìš”ì‹œì—ë§Œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.
                      </Alert>
                      <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 2, mb: 2 }}>
                        <TextField
                          label="í’ˆëª©ê·¸ë£¹ 1"
                          value={itemGroup1}
                          onChange={(e) => setItemGroup1(e.target.value)}
                          required
                          error={!itemGroup1.trim()}
                          helperText={!itemGroup1.trim() ? 'í•„ìˆ˜ ì…ë ¥' : 'ìš´ì˜ë¶€ì„œ ì…ë ¥ ì •ë³´'}
                        />
                        <TextField
                          label="í’ˆëª©ê·¸ë£¹ 2"
                          value={itemGroup2}
                          onChange={(e) => setItemGroup2(e.target.value)}
                          required
                          error={!itemGroup2.trim()}
                          helperText={!itemGroup2.trim() ? 'í•„ìˆ˜ ì…ë ¥' : 'ìš´ì˜ë¶€ì„œ ì…ë ¥ ì •ë³´'}
                        />
                        <TextField
                          label="í’ˆëª©ê·¸ë£¹ 3"
                          value={itemGroup3}
                          onChange={(e) => setItemGroup3(e.target.value)}
                          required
                          error={!itemGroup3.trim()}
                          helperText={!itemGroup3.trim() ? 'í•„ìˆ˜ ì…ë ¥' : 'ìš´ì˜ë¶€ì„œ ì…ë ¥ ì •ë³´'}
                        />
                      </Box>
                      <TextField
                        fullWidth
                        multiline
                        rows={3}
                        label="ì²˜ë¦¬ ì½”ë©˜íŠ¸"
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="ì´ì¹´ìš´íŠ¸ ë“±ë¡ì— ëŒ€í•œ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                        sx={{ mb: 2 }}
                      />
                    </CardContent>
                  </Card>
                )}

                {!editMode && canChangeStatus && request.currentStatus === 'ecount_registered' && (
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        ğŸ›’ êµ¬ë§¤ì²˜ ë°œì£¼ ì™„ë£Œ
                      </Typography>
                      <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2, mb: 2 }}>
                        <DatePicker
                          label="ì…ê³  ì˜ˆì •ì¼ *"
                          value={expectedDeliveryDate}
                          onChange={(newValue) => setExpectedDeliveryDate(newValue)}
                        />
                        <TextField
                          label="ì…ê³  ì˜ˆì • ìˆ˜ëŸ‰ *"
                          type="number"
                          value={expectedDeliveryQuantity}
                          onChange={(e) => setExpectedDeliveryQuantity(Number(e.target.value))}
                          InputProps={{ endAdornment: 'ê°œ' }}
                        />
                        <TextField
                          label="ì‹¤ì œ ë°œì£¼ì²˜"
                          value={actualSupplier}
                          onChange={(e) => setActualSupplier(e.target.value)}
                          placeholder={request.initialSupplier || 'êµ¬ë§¤ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”'}
                        />
                        <TextField
                          label="ë°œì£¼ ë©”ëª¨"
                          value={poMemo}
                          onChange={(e) => setPoMemo(e.target.value)}
                          placeholder="ë°œì£¼ ê´€ë ¨ ë©”ëª¨"
                        />
                      </Box>
                      <TextField
                        fullWidth
                        multiline
                        rows={3}
                        label="ì²˜ë¦¬ ì½”ë©˜íŠ¸ *"
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="êµ¬ë§¤ì²˜ ë°œì£¼ ì™„ë£Œì— ëŒ€í•œ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                        required
                      />
                    </CardContent>
                  </Card>
                )}

                {!editMode && canChangeStatus && request.currentStatus === 'po_completed' && (
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        ğŸ“¦ ë¬¼ë¥˜ì°½ê³  ì…ê³  ì™„ë£Œ
                      </Typography>
                      <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2, mb: 2 }}>
                        <DatePicker
                          label="ì‹¤ì œ ì…ê³ ì¼ *"
                          value={actualReceiptDate}
                          onChange={(newValue) => setActualReceiptDate(newValue)}
                        />
                        <TextField
                          label="ì‹¤ì œ ì…ê³  ìˆ˜ëŸ‰ *"
                          type="number"
                          value={actualReceivedQuantity}
                          onChange={(e) => setActualReceivedQuantity(Number(e.target.value))}
                          InputProps={{ endAdornment: 'ê°œ' }}
                        />
                        <TextField
                          label="ì…ê³  ë©”ëª¨"
                          value={warehouseReceiptMemo}
                          onChange={(e) => setWarehouseReceiptMemo(e.target.value)}
                          placeholder="ì…ê³  ê´€ë ¨ ë©”ëª¨"
                          sx={{ gridColumn: '1 / -1' }}
                        />
                      </Box>
                      <TextField
                        fullWidth
                        multiline
                        rows={3}
                        label="ì²˜ë¦¬ ì½”ë©˜íŠ¸ *"
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="ë¬¼ë¥˜ì°½ê³  ì…ê³  ì™„ë£Œì— ëŒ€í•œ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                        required
                      />
                    </CardContent>
                  </Card>
                )}

                {!editMode && canChangeStatus && (request.currentStatus === 'warehouse_received' || request.currentStatus === 'partial_dispatched') && (
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        ğŸšš ì§€ì  ì¶œê³  ì²˜ë¦¬
                      </Typography>
                      <Box sx={{ mb: 2 }}>
                        <Typography variant="body2" color="text.secondary" gutterBottom>
                          ì§€ì ë³„ ì¶œê³  ìˆ˜ëŸ‰ ì„¤ì •
                        </Typography>
                        {branchDispatchQuantities.map((branch, index) => (
                          <Box key={index} sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 1, p: 1, bgcolor: branch.isDispatched ? 'success.50' : 'grey.50', borderRadius: 1 }}>
                            <Typography variant="body2" sx={{ minWidth: 120 }}>
                              {branch.branchName}
                            </Typography>
                            <TextField
                              type="number"
                              size="small"
                              value={branch.dispatchedQuantity}
                              onChange={(e) => handleBranchDispatchQuantityChange(index, Number(e.target.value))}
                              InputProps={{ endAdornment: 'ê°œ' }}
                              sx={{ width: 150 }}
                            />
                            {branch.isDispatched ? (
                              <Button
                                size="small"
                                onClick={() => handleUndoBranchDispatch(index)}
                                color="warning"
                              >
                                ì¶œê³ ì·¨ì†Œ
                              </Button>
                            ) : (
                              <Button
                                size="small"
                                onClick={() => handleIndividualBranchDispatch(index)}
                                color="primary"
                              >
                                ì¶œê³ ì™„ë£Œ
                              </Button>
                            )}
                            {branch.isDispatched && (
                              <Chip label="âœ… ì¶œê³ ì™„ë£Œ" color="success" size="small" />
                            )}
                          </Box>
                        ))}
                      </Box>
                      <TextField
                        label="ì¶œê³  ë©”ëª¨"
                        value={dispatchMemo}
                        onChange={(e) => setDispatchMemo(e.target.value)}
                        placeholder="ì¶œê³  ê´€ë ¨ ë©”ëª¨"
                        fullWidth
                        sx={{ mb: 2 }}
                      />
                      <TextField
                        fullWidth
                        multiline
                        rows={3}
                        label="ì²˜ë¦¬ ì½”ë©˜íŠ¸"
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="ì§€ì  ì¶œê³ ì— ëŒ€í•œ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                      />
                    </CardContent>
                  </Card>
                )}

                {!editMode && canConfirmReceipt && request.currentStatus === 'branch_dispatched' && (
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        âœ… ì§€ì  ì…ê³  í™•ì¸
                      </Typography>
                      <Box sx={{ mb: 2 }}>
                        <Typography variant="body2" color="text.secondary" gutterBottom>
                          ì§€ì ë³„ ìˆ˜ë ¹ ìˆ˜ëŸ‰ í™•ì¸
                        </Typography>
                        {branchReceiptQuantities.map((branch, index) => (
                          <Box key={index} sx={{ p: 2, border: '1px solid', borderColor: 'grey.300', borderRadius: 1, mb: 2 }}>
                            <Typography variant="body2" fontWeight="medium" gutterBottom>
                              {branch.branchName}
                            </Typography>
                            <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2 }}>
                              <TextField
                                label="ì¶œê³  ìˆ˜ëŸ‰"
                                value={branch.dispatchedQuantity}
                                InputProps={{ endAdornment: 'ê°œ', readOnly: true }}
                                size="small"
                              />
                              <TextField
                                label="ìˆ˜ë ¹ ìˆ˜ëŸ‰"
                                type="number"
                                value={branch.confirmedQuantity || 0}
                                onChange={(e) => handleBranchReceiptQuantityChange(index, Number(e.target.value))}
                                InputProps={{ endAdornment: 'ê°œ' }}
                                size="small"
                              />
                            </Box>
                            <TextField
                              label="ìˆ˜ë ¹ ë©”ëª¨"
                              value={branch.branchReceiptMemo || ''}
                              onChange={(e) => handleBranchReceiptMemoChange(index, e.target.value)}
                              placeholder="ì§€ì  ìˆ˜ë ¹ ê´€ë ¨ ë©”ëª¨"
                              fullWidth
                              size="small"
                              sx={{ mt: 1 }}
                            />
                          </Box>
                        ))}
                      </Box>
                      <TextField
                        fullWidth
                        multiline
                        rows={3}
                        label="ì²˜ë¦¬ ì½”ë©˜íŠ¸ *"
                        value={comment}
                        onChange={(e) => setComment(e.target.value)}
                        placeholder="ì§€ì  ì…ê³  í™•ì¸ì— ëŒ€í•œ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                        required
                      />
                    </CardContent>
                  </Card>
                )}
              </>
            )}
          </Box>
        </DialogContent>

        <DialogActions>
          {/* í¸ì§‘ ëª¨ë“œ ë²„íŠ¼ë“¤ */}
          {editMode && editSection === 'ecount' && (
            <Button
              onClick={handleEcountUpdate}
              variant="contained"
              color="primary"
              disabled={processing || !itemGroup1.trim() || !itemGroup2.trim() || !itemGroup3.trim()}
            >
              {processing ? <CircularProgress size={20} /> : 'ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì •ë³´ ìˆ˜ì •'}
            </Button>
          )}
          
          {editMode && editSection === 'po' && (
            <Button
              onClick={handlePOUpdate}
              variant="contained"
              color="primary"
              disabled={processing || !expectedDeliveryDate || expectedDeliveryQuantity <= 0 || !comment.trim()}
            >
              {processing ? <CircularProgress size={20} /> : 'êµ¬ë§¤ì²˜ ë°œì£¼ ì •ë³´ ìˆ˜ì •'}
            </Button>
          )}
          
          {editMode && editSection === 'warehouse' && (
            <Button
              onClick={handleWarehouseUpdate}
              variant="contained"
              color="primary"
              disabled={processing || !actualReceiptDate || actualReceivedQuantity <= 0 || !comment.trim()}
            >
              {processing ? <CircularProgress size={20} /> : 'ë¬¼ë¥˜ì°½ê³  ì…ê³  ì •ë³´ ìˆ˜ì •'}
            </Button>
          )}
          
          {editMode && editSection === 'dispatch' && (
            <Button
              onClick={handleDispatchUpdate}
              variant="contained"
              color="primary"
              disabled={processing}
            >
              {processing ? <CircularProgress size={20} /> : 'ì§€ì  ì¶œê³  ì •ë³´ ìˆ˜ì •'}
            </Button>
          )}
          
          {editMode && editSection === 'receipt' && (
            <Button
              onClick={handleReceiptUpdate}
              variant="contained"
              color="primary"
              disabled={processing || !comment.trim()}
            >
              {processing ? <CircularProgress size={20} /> : 'ì§€ì  ì…ê³  í™•ì¸ ì •ë³´ ìˆ˜ì •'}
            </Button>
          )}

          {/* ì¼ë°˜ ëª¨ë“œ ìƒíƒœë³„ ì•¡ì…˜ ë²„íŠ¼ë“¤ */}
          {!editMode && canChangeStatus && request.currentStatus === 'operations_submitted' && (
            <Button
              onClick={handleEcountRegistration}
              variant="contained"
              color="primary"
              disabled={processing || !itemGroup1.trim() || !itemGroup2.trim() || !itemGroup3.trim()}
            >
              {processing ? <CircularProgress size={20} /> : 'ì´ì¹´ìš´íŠ¸ ë“±ë¡ ì™„ë£Œ'}
            </Button>
          )}

          {!editMode && canChangeStatus && request.currentStatus === 'ecount_registered' && (
            <Button
              onClick={handlePOCompletion}
              variant="contained"
              color="primary"
              disabled={processing || !expectedDeliveryDate || expectedDeliveryQuantity <= 0 || !comment.trim()}
            >
              {processing ? <CircularProgress size={20} /> : 'êµ¬ë§¤ì²˜ ë°œì£¼ ì™„ë£Œ'}
            </Button>
          )}

          {!editMode && canChangeStatus && request.currentStatus === 'po_completed' && (
            <Button
              onClick={handleWarehouseReceipt}
              variant="contained"
              color="primary"
              disabled={processing || !actualReceiptDate || actualReceivedQuantity <= 0 || !comment.trim()}
            >
              {processing ? <CircularProgress size={20} /> : 'ë¬¼ë¥˜ì°½ê³  ì…ê³  ì™„ë£Œ'}
            </Button>
          )}

          {!editMode && canChangeStatus && request.currentStatus === 'warehouse_received' && (
            <>
              <Button
                onClick={handlePartialDispatchSave}
                variant="outlined"
                color="primary"
                disabled={processing || branchDispatchQuantities.filter(b => b.isDispatched).length === 0}
              >
                {processing ? <CircularProgress size={20} /> : 'ë¶€ë¶„ ì¶œê³  ì €ì¥'}
              </Button>
              <Button
                onClick={handleBranchDispatch}
                variant="contained"
                color="primary"
                disabled={processing || branchDispatchQuantities.some(b => !b.isDispatched)}
              >
                {processing ? <CircularProgress size={20} /> : 'ì „ì²´ ì§€ì  ì¶œê³  ì™„ë£Œ'}
              </Button>
            </>
          )}

          {!editMode && canChangeStatus && request.currentStatus === 'partial_dispatched' && (
            <>
              <Button
                onClick={handleSaveCurrentState}
                variant="outlined"
                color="primary"
                disabled={processing}
              >
                {processing ? <CircularProgress size={20} /> : 'í˜„ì¬ ìƒíƒœ ì €ì¥'}
              </Button>
              <Button
                onClick={handleBranchDispatch}
                variant="contained"
                color="primary"
                disabled={processing || branchDispatchQuantities.some(b => !b.isDispatched)}
              >
                {processing ? <CircularProgress size={20} /> : 'ì „ì²´ ì§€ì  ì¶œê³  ì™„ë£Œ'}
              </Button>
            </>
          )}

          {!editMode && canConfirmReceipt && request.currentStatus === 'branch_dispatched' && (
            <Button
              onClick={handleBranchReceiptConfirmation}
              variant="contained"
              color="primary"
              disabled={processing || !comment.trim()}
            >
              {processing ? <CircularProgress size={20} /> : 'ì§€ì  ì…ê³  í™•ì¸ ì™„ë£Œ'}
            </Button>
          )}

          <Button onClick={onClose} color="secondary">
            ë‹«ê¸°
          </Button>
        </DialogActions>
      </Dialog>
    </LocalizationProvider>
  );
};

export default PurchaseRequestDetail;